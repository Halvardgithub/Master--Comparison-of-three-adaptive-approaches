---
title: "WinBUGS model"
author: "Halvard"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(R2WinBUGS)

#remotes::install_github("fisabio/pbugs")
library(pbugs)

library(readr)

library(sf)
library(spdep)
library(dplyr)
```

### Loading data
Load the data and spatial structures.
```{r}
ExpectedCases <- readRDS("ExpectedCasesMiguel.rds")
ObservedCases <- readRDS("ObservedCases.rds")
PopulationData <- readRDS("PopulationData.rds")
nDiseasesTot <- as.numeric(ncol(ObservedCases)) #the number of causes

shp_prov <- st_read("Data/Provinces/Provincias_ETRS89_30N.shp")
colnames(shp_prov) <- c("Index", "ProvName", "ProvName1", "CCAA_Index", "CCAA_Name", "geometry")
CCAA_to_remove <- c("Illes Balears", "Canarias", "Ceuta", "Melilla")
shp_prov <- filter(shp_prov, !CCAA_Name %in% CCAA_to_remove)
carto <- shp_prov

#Spatial structure
carto.nb <- poly2nb(carto) # Neighbours list of each geographic unit with class nb
carto.wb <- nb2WB(carto.nb) # List with the adjacency vector (carto.wb$adj) and
# the number of neighbors of each geographic unit (carto.wb$num) to use in WinBUGS
index <- c(1, cumsum(carto.wb$num)) # Vector to identify the positions of the neighbors
# of each geographic unit in the conditional distributions of spatial effects

#Randomize disease from 1-102 and do not need sex I think, numbers are 10, 20 and 50
get_causes <- function(n){ #nDiseasesTot is defined further up
  set.seed(12345)
  subset <- sample(1:nDiseasesTot, n, replace = FALSE) #there is a total of 102 diseases
  return(sort(subset))
}

causes10 <- get_causes(10) #the indexes corresponding to 10 random diseases, if n=20 we keep the first 10 and get 10 new ones
causes20 <- get_causes(20)
causes50 <- get_causes(50)

exp10 <- ExpectedCases[, causes10]
exp20 <- ExpectedCases[, causes20]
exp50 <- ExpectedCases[, causes50]

obs10 <- ObservedCases[, causes10]
obs20 <- ObservedCases[, causes20]
obs50 <- ObservedCases[, causes50]

```
Note that "Tumor Maligno del cruello del utero" in exp10 are all zero, so should be removed from the original datasets."Tumores in suto" is also extremely low. "XV.Embarazo, parto y puerpeira" as well. There is also some for homocides and maybe also accidents and such. 

### Implement the multivariate adaptive model with WinBUGS

Generally, i indicates a spatial region/province and j represents a disease or cause of death. 
```{r}
# Multivariate adaptive BYM model, WinBUGS code
AdaptiveBYM_model <- function() {
  # Likelihood
  for (i in 1:Nareas) {
    for (j in 1:Ndiseases) {
      O[i, j] ~ dpois(lambda[i, j])
      # Modeling of the mean for each census tract and disease
      log(lambda[i, j]) <- log(E[i, j]) + mu[j] + phi[i,j] + sd.theta[j] * theta[i, j]
      # SMR for each census tract and disease
      SMR[i, j] <- exp(mu[j] + phi[i, j] + sd.theta[j] * theta[i, j])
      # Prior distribution for spatial effects
      phi[i, j] ~ dnorm(mean.phi[i, j], prec.phi[i, j])
      # Prior distribution for non-spatial effects
      theta[i, j] ~ dnorm(0, 1)
    }
  }
  for (i in 1:n.adj) {
    sqrt.c.adj[i] <- sqrt(c[adj[i]])
    for (j in 1:Ndiseases) {
      phi.adj[i, j] <- phi[adj[i], j]
    }
  }
  # Precision of the conditional distribution of spatial effects
  for (j in 1:Ndiseases) {
    prec.phi[1, j] <- pow(sd.phi[j], -2) * sqrt(c[1]) * sum(sqrt.c.adj[index[1]:index[2]])
    for (i in 2:Nareas) {
      prec.phi[i, j] <- pow(sd.phi[j], -2) * sqrt(c[i]) * sum(sqrt.c.adj[(index[i] + 1):index[i + 1]]) #the +1 is to correct the indexes, works as all regions have at least one neighbour
    } 
  } 
  # Mean of the conditional distribution of spatial effects
  for (j in 1:Ndiseases) {
    mean.phi[1, j] <- inprod2(sqrt.c.adj[index[1]:index[2]],
      phi.adj[index[1]:index[2], j])/sum(sqrt.c.adj[index[1]:index[2]])
    for (i in 2:Nareas) {
      mean.phi[i, j] <- inprod2(sqrt.c.adj[(index[i] + 1):index[i + 1]], phi.adj[(index[i] + 1):index[i + 1], j])/sum(sqrt.c.adj[(index[i] + 1):index[i +1]])
    }
    # Sum-to-zero restriction for spatial effects
    ceros[j] <- 0
    ceros[j] ~ dnorm(sum.phi[j], 10)
    sum.phi[j] <- sum(phi[, j])
  }
  # Prior distributions for c
  for (i in 1:Nareas) {
    c[i] ~ dgamma(tau, tau) %_% I(0.001, ) # %_% 0.001 ensures c[i] is above 0.001
  }
  tau <- pow(sd.c, -2)
  sd.c ~ dunif(0, 5)
  # Other prior distributions
  for (j in 1:Ndiseases) {
    sd.phi[j] ~ dunif(0, 5)
    sd.theta[j] ~ dunif(0, 5)
    mu[j] ~ dflat()
  }
}
```


# Run the model
Now we are ready to run the model in WinBUGS. We choose the mortality causes, either 10, 20 or 50 causes and run the multivariate model.

```{r}
runtime <- rep(0, 3)

# 10 causes

t0 <- Sys.time()

causes.id <- causes10
# Data
data <- list(O = ObservedCases, E = ExpectedCases,
             Nareas = nrow(ObservedCases), Ndiseases = length(causes.id),
             n.adj = length(carto.wb$adj), adj = carto.wb$adj, index = index)
# Initial values
initials <- function() {
  list(mu = rnorm(data$Ndiseases, 0, 1), sd.phi = runif(data$Ndiseases,0, 1), 
       sd.theta = runif(data$Ndiseases, 0, 1), 
       phi = matrix(rnorm(data$Nareas * data$Ndiseases), nrow = data$Nareas, 
              ncol = data$Ndiseases),
       theta = matrix(rnorm(data$Nareas * data$Ndiseases),
              nrow = data$Nareas, ncol = data$Ndiseases), 
       c = runif(data$Nareas,0.9, 1.1), sd.c = runif(1, 0.5, 0.6))
}
# Variables to retrieve
param <- c("mu", "lambda", "sd.phi", "phi", "sd.theta", "theta","SMR", "c", "sd.c", "tau")
# Calls to WinBUGS
results.AdaptiveBYM.10 <- pbugs(data = data, inits = initials,
                              parameters.to.save = param, model = AdaptiveBYM_model,
                              n.iter = 5000, n.burnin = 2000, n.chains = 3, DIC = F,
                              debug = F)
t1 <- Sys.time()
runtime[1] <- t1 - t0

# 20 causes

t0 <- Sys.time()

causes.id <- causes20
# Data
data <- list(O = ObservedCases, E = ExpectedCases,
             Nareas = nrow(ObservedCases), Ndiseases = length(causes.id),
             n.adj = length(carto.wb$adj), adj = carto.wb$adj, index = index)
# Initial values
initials <- function() {
  list(mu = rnorm(data$Ndiseases, 0, 1), sd.phi = runif(data$Ndiseases,0, 1), 
       sd.theta = runif(data$Ndiseases, 0, 1), 
       phi = matrix(rnorm(data$Nareas * data$Ndiseases), nrow = data$Nareas, 
              ncol = data$Ndiseases),
       theta = matrix(rnorm(data$Nareas * data$Ndiseases),
              nrow = data$Nareas, ncol = data$Ndiseases), 
       c = runif(data$Nareas,0.9, 1.1), sd.c = runif(1, 0.5, 0.6))
}
# Variables to retrieve
param <- c("mu", "lambda", "sd.phi", "phi", "sd.theta", "theta","SMR", "c", "sd.c", "tau")
# Calls to WinBUGS
results.AdaptiveBYM.20 <- pbugs(data = data, inits = initials,
                              parameters.to.save = param, model = AdaptiveBYM_model,
                              n.iter = 5000, n.burnin = 2000, n.chains = 3, DIC = F,
                              debug = F)
t1 <- Sys.time()
runtime[2] <- t1 - t0

# 50 causes

t0 <- Sys.time()

causes.id <- causes50
# Data
data <- list(O = ObservedCases, E = ExpectedCases,
             Nareas = nrow(ObservedCases), Ndiseases = length(causes.id),
             n.adj = length(carto.wb$adj), adj = carto.wb$adj, index = index)
# Initial values
initials <- function() {
  list(mu = rnorm(data$Ndiseases, 0, 1), sd.phi = runif(data$Ndiseases,0, 1), 
       sd.theta = runif(data$Ndiseases, 0, 1), 
       phi = matrix(rnorm(data$Nareas * data$Ndiseases), nrow = data$Nareas, 
              ncol = data$Ndiseases),
       theta = matrix(rnorm(data$Nareas * data$Ndiseases),
              nrow = data$Nareas, ncol = data$Ndiseases), 
       c = runif(data$Nareas,0.9, 1.1), sd.c = runif(1, 0.5, 0.6))
}
# Variables to retrieve
param <- c("mu", "lambda", "sd.phi", "phi", "sd.theta", "theta","SMR", "c", "sd.c", "tau")
# Calls to WinBUGS
results.AdaptiveBYM.50 <- pbugs(data = data, inits = initials,
                              parameters.to.save = param, model = AdaptiveBYM_model,
                              n.iter = 5000, n.burnin = 2000, n.chains = 3, DIC = F,
                              debug = F)
t1 <- Sys.time()
runtime[3] <- t1 - t0

# Comparing runtimes

runtime
```

```{r}
result_list <- list(results.AdaptiveBYM.10, results.AdaptiveBYM.20, results.AdaptiveBYM.50)
saveRDS(result_list, file = "Results//result_list.rds")
```


```{r}
ss_provinces = read_sf("Data/Provinces/Provincias_ETRS89_30N.shp")

ss_ar = read_sf("Data/AutonomousRegions/Comunidades_Autonomas_ETRS89_30N.shp")

ggplot() + geom_sf(data = ss_provinces) + geom_sf(data = ss_ar)

# we only work with mainland Spain, remove the islands

out = c("Islas Baleares", "Las Palmas", "Santa Cruz de Tenerife", "Ceuta", "Melilla")

out2 = c("Canarias", "Islas Baleares", "Ceuta", "Melilla")

ss_provinces = ss_provinces |> filter(!(Texto %in% out))

ss_ar = ss_ar %>% filter(!(Texto %in% out2))

#can change the fill=NA to add colours
ggplot() +
  geom_sf(data = ss_ar, color="black") + #do not really need this line
  geom_sf(data=ss_provinces, fill=NA, color="grey") +
  geom_sf(data = ss_ar, color="black", fill=NA,linewidth = 0.4)
```




## For leave one out cross-validation for the diseases and simulation of the weight matrix
```{r}
# Object where the results for each set of diseases will be
# saved
results.AdaptiveBYM <- list()
# Run multivariate adaptive BYM model for each set of
# diseases
causes <- causes10
for (i in 1:length(causes)) { #corresponds to the n in the line above
  # Selection of mortality causes
  causes.id <- causes[-c(i)]
  # Data
  data <- list(O = ObservedCases, E = ExpectedCases,
               Nareas = nrow(ObservedCases), Ndiseases = length(causes.id),
               n.adj = length(carto.wb$adj), adj = carto.wb$adj, index = index)
  # Initial values
  initials <- function() {
    list(mu = rnorm(data$Ndiseases, 0, 1), sd.phi = runif(data$Ndiseases,0, 1), 
         sd.theta = runif(data$Ndiseases, 0, 1), 
         phi = matrix(rnorm(data$Nareas * data$Ndiseases), nrow = data$Nareas, 
                ncol = data$Ndiseases),
         theta = matrix(rnorm(data$Nareas * data$Ndiseases),
                nrow = data$Nareas, ncol = data$Ndiseases), 
         c = runif(data$Nareas,0.9, 1.1), sd.c = runif(1, 0.5, 0.6))
  }
  # Variables to retrieve
  param <- c("mu", "lambda", "sd.phi", "phi", "sd.theta", "theta","SMR", "c", "sd.c", "tau")
  # Calls to WinBUGS
  results.AdaptiveBYM[[i]] <- bugs(data = data, inits = initials,
                                    parameters.to.save = param, model = AdaptiveBYM_model,
                                    n.iter = 20, n.burnin = 10, n.chains = 3, DIC = F,
                                   debug = F)
}
# Save results
write_csv(results.AdaptiveBYM, file = "Results/results.AdaptiveBYM-Miguel.csv")


```

It gave an error called trap 66, which means it failed in WinBUGS I believe.







